<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.16" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/images/favicon.jpg" type="image/x-icon" />

    
    <title>Step 2: TOTP Login</title>
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/horsey.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    <script src="/js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    
<link href="/css/yosai_tutorial.css" rel="stylesheet">

  </head>
  <body class="" data-url="/04.totp_login/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://yosaiproject.github.io/yosai">
<img src="/images/yosai.jpg" />
</a>

    </div>
    
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
        
      
      
      
      

      
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/">
        <a href="/">
          <span>
            
             TOTP Tutorial
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/01.overview/">
        <a href="/01.overview/">
          <span>
            
              <b>1. </b>
            
             Overview
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/01.overview/01.totp_in_nutshell/">
              <a href="/01.overview/01.totp_in_nutshell/">
                <span>TOTP In a Nutshell     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/01.overview/02.passlib_totp/">
              <a href="/01.overview/02.passlib_totp/">
                <span>Passlib TOTP     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/01.overview/03.totp_sources/">
              <a href="/01.overview/03.totp_sources/">
                <span>Token Stores     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/01.overview/04.totp_token/">
              <a href="/01.overview/04.totp_token/">
                <span>TOTP Token     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/01.overview/05.user_key/">
              <a href="/01.overview/05.user_key/">
                <span>User-Specific Key     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/02.user_setup/">
        <a href="/02.user_setup/">
          <span>
            
              <b>2. </b>
            
             TOTP Setup
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/01.create_totp_factory/">
              <a href="/02.user_setup/01.create_totp_factory/">
                <span>TOTP Factory     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/02.generate_totp_instance/">
              <a href="/02.user_setup/02.generate_totp_instance/">
                <span>Generate TOTP     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/03.encrypt_serialize_totp/">
              <a href="/02.user_setup/03.encrypt_serialize_totp/">
                <span>Encrypt &amp; Serialize     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/04.obtain_totp_key/">
              <a href="/02.user_setup/04.obtain_totp_key/">
                <span>TOTP Key     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/05.share_key/">
              <a href="/02.user_setup/05.share_key/">
                <span>Share Key     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/02.user_setup/06.persist_key_to_db/">
              <a href="/02.user_setup/06.persist_key_to_db/">
                <span>Save Key     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/03.userpass_login/">
        <a href="/03.userpass_login/">
          <span>
            
              <b>3. </b>
            
             Step 1: UserPass Login
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item active parent" data-nav-id="/04.totp_login/">
        <a href="/04.totp_login/">
          <span>
            
              <b>4. </b>
            
             Step 2: TOTP Login
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/05.rate_limiting/">
        <a href="/05.rate_limiting/">
          <span>
            
              <b>5. </b>
            
             Rate Limiting
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/06.settings/">
        <a href="/06.settings/">
          <span>
            
              <b>6. </b>
            
             Settings
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/06.settings/01.dispatcher/">
              <a href="/06.settings/01.dispatcher/">
                <span>SMS Dispatcher     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/06.settings/02.totp_context/">
              <a href="/06.settings/02.totp_context/">
                <span>TOTP Context     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/06.settings/03.secrets/">
              <a href="/06.settings/03.secrets/">
                <span>Secrets     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/07.references/">
        <a href="/07.references/">
          <span>
            
              <b>7. </b>
            
             References
            
           </span>
        </a>
        
      </li>
      
      
    </ul>
    <hr>
     
    <section id="footer">
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                  
                
                  
                
                  
                
                  
                
                <span itemprop="title"> Step 2: TOTP Login</span>
              </div>
              

            </div>
            
              <div id="chapter">
            
    	        <div id="body-inner">
                



<h2 id="center-step-2-totp-login-center"><center> Step 2: TOTP Login </center></h2>

<p>If a user is configured for two-factor authentication and username/password
is verified, Yosai signals to the calling application to collect 2FA information
from its client by raising an <strong>AdditionalAuthenticationRequired</strong> exception.</p>

<pre><code class="language-python">        try:
            new_subject.login(password_token)
        except AdditionalAuthenticationRequired:
            # this is pseudocode:
            request_totp_token_from_client()
</code></pre>

<p>Additionally, Yosai will call an <strong>MFADispatcher</strong>, if one is configured,
to send information to the client.  One such implementation of an
<strong>MFADispatcher</strong> is an <a href="https://github.com/YosaiProject/yosai_totp_sms">SMSDispatcher</a>
that SMS messages a client a newly-generated TOTP token (a 6-digit integer).
The Dispatcher is called prior to raising the AdditionalAuthenticationRequired exception.</p>

<p><img src="img/totp_sms.png" alt="mfa_dispatcher" /></p>

<h3 id="totp-authentication-step-3-totp-key-entry">TOTP Authentication Step 3: TOTP Key Entry</h3>

<p>Client is prompted to enter a TOTP token.  Client submits the requested
totp token to the server, authenticating itself.</p>

<p><img src="img/totp_token.png" alt="totp_token_login" /></p>

<h3 id="server-side-second-authentication-request-totptoken">Server-side Second Authentication Request:  TOTPToken</h3>

<pre><code class="language-python">    with Yosai.context(yosai):
        new_subject = Yosai.get_current_subject()

        totp_token = TOTPToken(client_provided_totp_token)

        try:
            new_subject.login(totp_token)
        except IncorrectCredentialsException:
            # incorrect totp token provided
        except LockedAccountException:
            # too many failed TOTP authentication attempts, account locked
        except InvalidAuthenticationSequenceException:
            # when TOTPToken authentication is attempted prior to username/password
</code></pre>

<h2 id="token-consumption">Token Consumption</h2>

<p>In order to control for a one-time password to truly be used once, Yosai caches
the TOTP Token that successfully authenticated.  If an attacker were to try to
replay totp authentication, any subsequent TOTP authentication of the valid
token would raise an IncorrectCredentialsException.  Granted, without this
token consumption facility, an attacker would have a very small window of
opportunity &ndash; seconds &ndash; to replay a TOTP Token before a new one would be required for
authentication.</p>


      
        </div> 
      
      </div>
    </div>

    <div id="navigation">
        <a class="nav nav-prev" href="/03.userpass_login"> <i class="fa fa-chevron-left"></i></a>
        <a class="nav nav-next" href="/05.rate_limiting" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky-kit.min.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>
    

  </body>
</html>

