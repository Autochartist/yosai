<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Session Management - Yosai</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->


    </head>

    <body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- Main title -->
                <a class="active navbar-brand" href="..">Yosai</a>
            </div>
            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Get Started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="../intro/">Introduction</a>
                            </li>
                            <li>
                                <a href="../installation_setup/">Installation and Setup</a>
                            </li>
                            <li >
                                <a href="../quickstart/">Quick-Start</a>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="../authentication/">Authentication</a>
                            </li>
                            <li>
                                <a href="../authorization/">Authorization</a>
                            </li>
                            <li class="active">
                                <a href="./">Session Management</a>
                            </li>
                            <li>
                                <a href="../events/">Event Processing</a>
                            </li>
                            <li>
                                <a href="../serialization/">Serialization</a>
                            </li>
                            <li>
                                <a href="../architecture/">Architecture Overview</a>
                            </li>
                            <li>
                                <a href="../web">Web Integration</a>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="../devstatus/">Development Status</a>
                            </li>
                            <li>
                                <a href="../library/">Library</a>
                            </li>
                            <li>
                                <a href="../community/">Community</a>
                            </li>
                            <li>
                                <a href="../credits/">Credits</a>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="tutorials/totp_tutorial">TOTP Authentication</a>
                            </li>
                        </ul>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                    </li>

                    <li >
                        <a rel="next" href="../authorization/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../events/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/yosaiproject">

                            <i class="fa fa-github"></i> GitHub
                        </a>
                    </li>

                </ul>
            </div>
        </div>
    </div>


  <div class="container">

                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">

        <li class="main active"><a href="#sessions-and-session-management">Sessions and Session Management</a></li>

            <li><a href="#authentication-authorization-and-session-management-are-related">Authentication, Authorization, and Session Management are Related</a></li>

            <li><a href="#properties-of-a-session-session-risk-and-risk-countermeasures">Properties of a Session , Session Risk, and Risk Countermeasures</a></li>

            <li><a href="#the-session-synchronization-design-challenge">The Session Synchronization Design Challenge</a></li>

            <li><a href="#session-invalidation">Session Invalidation</a></li>

            <li><a href="#session-usage">Session Usage</a></li>

            <li><a href="#session-storage">Session Storage</a></li>

            <li><a href="#session-events">Session Events</a></li>


        <li class="main "><a href="#session-tutorial">Session Tutorial</a></li>

            <li><a href="#shopping-cart-manager">Shopping Cart Manager</a></li>

            <li><a href="#operation-1-add-four-items-to-the-shopping-cart">Operation 1:  Add four items to the shopping cart</a></li>

            <li><a href="#operation-2-remove-an-item-from-the-shopping-cart">Operation 2:  Remove an item from the shopping cart</a></li>

            <li><a href="#here-is-a-fully-working-example-of-the-code-shared-above">Here is a fully working example of the code shared above.</a></li>

            <li><a href="#references">References</a></li>


    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="sessions-and-session-management">Sessions and Session Management</h1>
<p><img alt="sessionman" src="../img/sessionmanagement.png" /></p>
<p>Use Sessions to track the state of a user's interactions with your application across multiple requests, over a specified period of time.  Tracking user state with Sessions enables more feature-rich user experiences.  Further, Sessions play a major role in access control.</p>
<p>Session Management involves creating, reading, updating, and deleting of Sessions and Session attributes, and validating Sessions.</p>
<p>Yosai's <code>SessionManager</code> uses a <code>CachingSessionStore</code> to cache sessions. If you are not caching sessions, you you are either using in-memory session storage  (the <code>MemorySessionStore</code>) or using your own custom SessionStore, which is beyond the scope of consideration in this documentation.</p>
<h2 id="authentication-authorization-and-session-management-are-related">Authentication, Authorization, and Session Management are Related</h2>
<p>Access is limited by user identity: a guest cannot perform the operations that an authenticated user can, and each authenticated user may perform different operations.</p>
<p>The identity of an authenticated user is recorded in the Session.</p>
<p>Since access control is limited by identity, and identity is obtained from a Session, access control is considered <em>bound</em> to a Session.</p>
<h2 id="properties-of-a-session-session-risk-and-risk-countermeasures">Properties of a Session , Session Risk, and Risk Countermeasures</h2>
<p>Sessions are a "threat vector":  a path that an "actor" may exploit to attack a "target" (your application).  Sessions are exploited by a process known as hijacking.  Session Management helps to manage many of the inherent risks of Sessions through a series of countermeasures.  More information about these countermeasures follows in the documentation.</p>
<h3 id="the-session-token">The Session Token</h3>
<p>A Session Token is like a smart chip, or magnetic strip, on a credit card in that it contains identification-- a session identifier (SessionID).  However, unlike the elements of a credit card, the Session Token has a much shorter lifespan.</p>
<p>The <code>SessionID</code> is a sensitive and critical piece of information.  It uniquely identifies a Session.  It is the Session's key in a SessionStore (cache) and it is the key that is sent with subsequent requests by a client (the user).</p>
<p>Once an authenticated session is established, the <code>SessionID</code> is the client's key to Yosai.  Therefore, it is very important that the session identifier be unique and very difficult to reproduce.  </p>
<p>Yosai's default method to generate a <code>SessionID</code> is as follows:
<code>sha256(sha512(urandom(20)).digest()).hexdigest()</code></p>
<h3 id="temporal-risks-and-countermeasures">Temporal Risks and Countermeasures</h3>
<p>The risk of compromising a Session increases as time passes.  To address time-driven risks, Yosai defines temporal properties in a Session -- idle time and maximum allowable time to live (TTL) -- that enable "timing out" of Sessions.</p>
<p>When a Session "times out", it is considered <strong>expired</strong>.  When a Session is <strong>expired</strong>, it can no longer be used in Yosai, and therefore is no longer at risk of being hijacked.</p>
<p>The timeout thresholds are configured in the Yosai settings YAML file. Should you find their default settings unacceptable, you can easily change them.  The default settings are somewhat aggressive so as to minimize the risks that defaults may present and to encourage developers to take ownership of session time-out decisions.</p>
<h3 id="idle-time">Idle time</h3>
<p><img alt="idle_timeout" src="../img/idle.png" /></p>
<p>This property represents the total permissible time for a user to be inactive in a system, or idle.  Picture idle timeout as an hourglass that is turned over and reset periodically. The way that idle time is reset is by updating the Session's <code>last_access_time</code> attribute.  As to when the <code>last_access_time</code> is updated depends on what "auto_touch" has been configured to or whether you've chosen an alternative time to touch than the default (per-access).</p>
<p>A <code>DefaultNativeSessionManager</code> has an attribute, "auto_touch", that when set to True will allow the updating of a Session's <code>last_access_time</code> attribute to the current time, whenever a session is accessed, following Session validation. As mentioned, when a Session should be touched depends on the type of application you are developing and thus auto_touch is a configurable feature.  When a Session is obtained from the SessionStore, it is immediately validated.  Should the validation not raise any exceptions, and if auto_touch is True, the Session will be "touched".  Touching a Session is the process of flipping and resetting the hourglass, so to speak, by updating the <code>last_access_time</code> attribute of the Session.</p>
<p>Yosai's default idle time setting for a Session is <strong>5 minutes</strong>.</p>
<h3 id="time-to-live">Time to live</h3>
<p><img alt="ttl" src="../img/ttl.png" /></p>
<p>A Session has a maximum allowable time period that it may exist.  It is the final countdown until a Session is expired. It cannot be reset, unlike idle timeout. Many computer systems refer to this as a TTL -- time to live.  Yosai's default time-to-live for a Session is <strong>30 minutes</strong>.</p>
<h3 id="stopping-sessions">Stopping Sessions</h3>
<p>Aside from expirations, another mechanism for rendering Sessions useless in is <strong>stopping</strong> them.  When a subject logs out of a system, the subject's Session is stopped.  Like an expired Session, a <strong>stopped</strong> Session can no longer be used and is consequently no longer at risk of being hijacked.</p>
<h3 id="session-validation">Session Validation</h3>
<p>Session Validation is the process of determining whether a Session has stopped or expired.  When a session has stopped or expired, it is considered <strong>invalid</strong>.</p>
<p>A Session expires when the time duration between the current time and the last recorded time that a Session was accessed exceeds either timeout threshold.</p>
<p>Keeping track of idle expiration presents performance challenges.  Therefore, Sessions are validated <em>only</em> when they are accessed (i.e. subject.get_session()).</p>
<p>the last_access_timestamp synchronized with session usage presents a</p>
<p>if the duration between the last_access_timestamp and the current time exceeds either timeout threshold, a session is considered expired</p>
<p>By default, Sessions are "lazy validated" in that they are validated at the time that [they are accessed?].</p>
<p>As discussed in an earlier section above, access control is <em>bound</em> to a Session. Since access control is <em>bound</em> to a Session, when a Session is invalidated so too does the authorization information cached for the Session.  Invalid authorization information is cleared from cache through event handling.</p>
<h3 id="idle-timeout-edge-case">Idle Timeout Edge Case</h3>
<p>Monitoring for idle timeout increases the complexity of Session Management.
As discussed, Session validation taxes the performance of an application and
therefore does not run before every authorization check.  Instead, validation
is designed to maximize utility for the most popular use case-- one where the
subject instance has a short life span in memory and sessions validate when
they are accessed.</p>
<p>Therefore, it is recommended that you release a Subject instance for garbage
collection between requests.</p>
<h2 id="the-session-synchronization-design-challenge">The Session Synchronization Design Challenge</h2>
<p>Keeping the last_access_timestamp synchronized with session usage presents a performance design challenge that you are encouraged to help improve.  Ideas are welcome!</p>
<h2 id="session-invalidation">Session Invalidation</h2>
<p>By default, whenever Yosai detects an invalid session, it attempts to delete it from the underlying session data store via the SessionStore.delete(session) method.  However, should you decide not to automatically delete invalid sessions, you can easily opt-out of this process.  For example, if your application uses a SessionStore that backs a queryable data store, perhaps your dev team wants old or invalid sessions to be available for a certain period of time. Storing invalid sessions would allow you to run queries against the data store to see, for example, how many sessions a user has created over the last week, or the average duration of a user's sessions, or similar reporting-type queries.</p>
<p>At Session expiration, Yosai ties up loose ends, so to speak, through its event-driven architecture.</p>
<h2 id="session-usage">Session Usage</h2>
<h3 id="session-initialization">Session Initialization</h3>
<p>A Session can be used to manage state for a Subject regardless of whether the Subject has authenticated itself or remains anonymous.  Yosai initializes a server-side Session when a Subject is instantiated.</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">from</span> <span style="color: #f8f8f2">yosai.core</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">Yosai,</span> <span style="color: #f8f8f2">UsernamePasswordToken</span>

<span style="color: #75715e"># creates an &quot;anonymous session&quot; if the current executing subject hasn&#39;t</span>
<span style="color: #75715e"># logged in yet:</span>
<span style="color: #f8f8f2">yosai</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai(env_var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;YOSAI_SETTINGS&#39;</span><span style="color: #f8f8f2">)</span>

<span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">context(yosai):</span>
  <span style="color: #f8f8f2">guest</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_current_subject()</span>  <span style="color: #75715e"># session is created in the process</span>
  <span style="color: #f8f8f2">session</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">subject</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_session()</span>
</pre></div>


<p>After a user authenticates itself, Yosai creates a new session for the user. This is done for a few reasons.  The user's access to the system changes as the user's identity changes (from anonymous to authenticated).  A new, "authenticated session" replaces the "anonymous session" the moment that a subject is authenticated as a user:</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">from</span> <span style="color: #f8f8f2">yosai.core</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">Yosai,</span> <span style="color: #f8f8f2">UsernamePasswordToken</span>

<span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">context(yosai):</span>
  <span style="color: #75715e"># creates an &quot;anonymous session&quot; if the current executing subject hasn&#39;t</span>
  <span style="color: #75715e"># logged in yet:</span>
  <span style="color: #f8f8f2">subject</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_current_subject()</span>

  <span style="color: #f8f8f2">authc_token</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">UsernamePasswordToken(username</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;thedude&#39;</span><span style="color: #f8f8f2">,</span>
                                      <span style="color: #f8f8f2">credentials</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;letsgobowling&#39;</span><span style="color: #f8f8f2">)</span>

  <span style="color: #75715e"># creates an &quot;authenticated session&quot; if login in successful, raising</span>
  <span style="color: #75715e"># an exception otherwise (try/except left out to simplify the example):</span>
  <span style="color: #f8f8f2">subject</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">login(authc_token)</span>
</pre></div>


<div class="admonition note">
<p>It is recommended that the session be regenerated by the application after     <strong>any</strong> privilege level change within the associated user session.</p>
</div>
<h2 id="session-storage">Session Storage</h2>
<p>Whenever a Session is created or updated, its data is persisted to a storage location so that it may be accessible by the application at a later time. Similarly, when a Session is invalid and longer being used, it is deleted from storage so that the Session data store space is not exhausted (if you're not taking advantage of TTL expiration in your data store).</p>
<p>The SessionManager implementations delegate these Create/Read/Update/Delete (CRUD) operations to an internal component, the SessionStore, which reflects the Data Access Object (DAO) design pattern.</p>
<p>The power of the SessionStore is that you can implement this interface to communicate with any data store you wish. This means your session data can reside in memory, on the file system, in a relational database or NoSQL data store, or any other location you want. You have control over persistence behavior.</p>
<p>Yosai features an in-memory MemorySessionStore and CachingSessionStore.  The CachingSessionStore is the default, and recommended, SessionStore for Yosai.</p>
<h2 id="session-events">Session Events</h2>
<p>An Event is emitted to the singleton EventBus, in Yosai, when a Session is <em>started</em>, <em>stopped</em>, or <em>expired</em>.  If you would like to learn more about Event processing, please refer to the documentation about Event Processing.</p>
<p>Events are communicated using a publish-subscribe paradigm.  In the case of Sessions, a <code>SessionEventHandler</code> publishes an event to a channel (an internal Event Bus). The EventBus relays an event to consumers who have subscribed to the event's topic. It relays the event by calling the callback method registered for a consumer, using the event payload as its argument(s).</p>
<p>The following table lists the Session-related events and who the subscriber(s) are:</p>
<table>
<thead>
<tr>
<th>Event Topic</th>
<th>Subscriber(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>SESSION.START</td>
<td>EL</td>
</tr>
<tr>
<td>SESSION.STOP</td>
<td>MRA, EL</td>
</tr>
<tr>
<td>SESSION.EXPIRE</td>
<td>MRA, EL</td>
</tr>
</tbody>
</table>
<ul>
<li>MRA = <code>yosai.core.authz.authz.ModularRealmAuthorizer</code></li>
<li>SEH = <code>yosai.core.session.session.SessionEventHandler</code></li>
</ul>
<h3 id="example-sessionexpire-event-processing">Example:  SESSION.EXPIRE Event Processing</h3>
<p>At Yosai initialization, <code>yosai.core.authz.authz.ModularRealmAuthorizer</code> subscribes to a few event topics, one of which is 'SESSION.EXPIRE'. When it subscribes to the 'SESSION.EXPIRE' topic, it registers a callback method, <code>session_clears_cache</code>.  This callback method is called by the EventBus whenever a 'SESSION.EXPIRE' event is emitted to the bus.</p>
<p>A <code>SESSION.EXPIRE</code> event is emitted by a <code>yosai.core.session.session.SessionEventHandler</code> when Session Validation has recognized a Session as expired.</p>
<p>As of yosai.core v0.1.0, the <code>ModularRealmAuthorizer</code> and <code>EventLogger</code> are the two subscribers of the <code>SESSION.EXPIRE</code> topic (see table above).  The callback method registered for each subscriber is called in an arbitrary, sequential fasion (PyPubSub design) when a SessionEventHandler emits a SESSION.EXPIRE event to the Eventbus.</p>
<p>Here is an example of an <code>expired-session</code> event processing through Yosai, omitting event logging processing:</p>
<p><img alt="" src="../img/session_event_processing.png" /></p>
<h1 id="session-tutorial">Session Tutorial</h1>
<p>In this tutorial, you will learn how to use the Session API to perform server-side session management.  We'll use a shopping cart example to illustrate how to manage state using a Session object.  You will learn how to:</p>
<ol>
<li>define marshalling logic required to properly (de)serialize custom objects</li>
<li>manage sessions using Yosai's Session API, including:</li>
<li>get_attribute</li>
<li>set_attribute</li>
<li>remove_attribute</li>
</ol>
<p>This is <em>not</em> a primer on how to write your own e-commerce shopping cart application.  This example is intended to illustrate the Session API.  This ShoppingCart uses a really stripped down, dumb model intended to show you how to control the marshalling of custom
objects.</p>
<p>Marshalling supports standard object types from the standard library.  When you use objects other than standard primitives, such as objects from the collections library,
you'll need to control conversion of your objects to supported data types, and vice versa, by implementing <strong>setstate</strong> and <strong>getstate</strong> methods within your serializables:</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">ShoppingCartItem</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">collections</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">namedtuple(</span><span style="color: #e6db74">&#39;ShoppingCartItem&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;upc title&#39;</span><span style="color: #f8f8f2">)</span>

<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">ShoppingCart</span><span style="color: #f8f8f2">:</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">__init__</span><span style="color: #f8f8f2">(self):</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">collections</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">defaultdict(int)</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">add_item</span><span style="color: #f8f8f2">(self,</span> <span style="color: #f8f8f2">item,</span> <span style="color: #f8f8f2">quantity</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">):</span>
        <span style="color: #e6db74">&quot;&quot;&quot;</span>
<span style="color: #e6db74">        :param item: a ShoppingCartItem namedtuple</span>
<span style="color: #e6db74">        :type quantity: int</span>
<span style="color: #e6db74">        &quot;&quot;&quot;</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket[item]</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">quantity</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">remove_item</span><span style="color: #f8f8f2">(self,</span> <span style="color: #f8f8f2">item):</span>
        <span style="color: #e6db74">&quot;&quot;&quot;</span>
<span style="color: #e6db74">        :param item: a ShoppingCartItem namedtuple</span>
<span style="color: #e6db74">        &quot;&quot;&quot;</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pop(item)</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">__getstate__</span><span style="color: #f8f8f2">(self):</span>
        <span style="color: #75715e"># neither defaultdict nor tuple key is supported for serialization</span>
        <span style="color: #75715e"># so we must convert them:</span>
        <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">{</span><span style="color: #e6db74">&#39;basket&#39;</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">{</span><span style="color: #e6db74">&#39;{0}|{1}&#39;</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">format(key</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">upc,</span> <span style="color: #f8f8f2">key</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">title):</span> <span style="color: #f8f8f2">value</span>
                           <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">key,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">items()}}</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">__setstate__</span><span style="color: #f8f8f2">(self,</span> <span style="color: #f8f8f2">state):</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">collections</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">defaultdict(int)</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">key,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">state[</span><span style="color: #e6db74">&#39;basket&#39;</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">items():</span>
            <span style="color: #f8f8f2">keys</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">key</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">split(</span><span style="color: #e6db74">&quot;|&quot;</span><span style="color: #f8f8f2">)</span>
            <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">basket[ShoppingCartItem(upc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">keys[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">title</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">keys[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">])]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">value</span>
</pre></div>


<p>You are ready to initialize Yosai with shopping-cart enabled session management
capabilities.  Simply pass the serializable during Yosai initialization within
a list:</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">yosai</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai(env_var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;YOSAI_SETTINGS&#39;</span><span style="color: #f8f8f2">,</span>
                  <span style="color: #f8f8f2">session_attributes</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[ShoppingCart])</span>
</pre></div>


<p>Here's one way you could interact with the shopping cart in your application using
Yosai session management:</p>
<h3 id="shopping-cart-manager">Shopping Cart Manager</h3>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">ShoppingCartSessionManager</span><span style="color: #f8f8f2">:</span>

    <span style="color: #a6e22e">@staticmethod</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">list_items</span><span style="color: #f8f8f2">(session):</span>
        <span style="color: #f8f8f2">shopping_cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">session</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_attribute(</span><span style="color: #e6db74">&#39;shopping_cart&#39;</span><span style="color: #f8f8f2">)</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">shopping_cart:</span>
            <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">shopping_cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">items()</span>
        <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">None</span>

    <span style="color: #a6e22e">@staticmethod</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">add_item</span><span style="color: #f8f8f2">(session,</span> <span style="color: #f8f8f2">item,</span> <span style="color: #f8f8f2">quantity</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">):</span>
        <span style="color: #e6db74">&quot;&quot;&quot;</span>
<span style="color: #e6db74">        :param item: a ShoppingCartItem namedtuple</span>
<span style="color: #e6db74">        &quot;&quot;&quot;</span>
        <span style="color: #f8f8f2">shopping_cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">session</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_attribute(</span><span style="color: #e6db74">&#39;shopping_cart&#39;</span><span style="color: #f8f8f2">)</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">shopping_cart:</span>
            <span style="color: #f8f8f2">shopping_cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add_item(item,</span> <span style="color: #f8f8f2">quantity)</span>
        <span style="color: #66d9ef">else</span><span style="color: #f8f8f2">:</span>
            <span style="color: #f8f8f2">shopping_cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ShoppingCart()</span>
        <span style="color: #f8f8f2">session</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">set_attribute(</span><span style="color: #e6db74">&#39;shopping_cart&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">shopping_cart)</span>


    <span style="color: #a6e22e">@staticmethod</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">remove_item</span><span style="color: #f8f8f2">(session,</span> <span style="color: #f8f8f2">item):</span>
        <span style="color: #f8f8f2">shopping_cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">session</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_attribute(</span><span style="color: #e6db74">&#39;shopping_cart&#39;</span><span style="color: #f8f8f2">)</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">shopping_cart:</span>
            <span style="color: #f8f8f2">shopping_cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">remove_item(item)</span>
            <span style="color: #f8f8f2">session</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">set_attribute(</span><span style="color: #e6db74">&#39;shopping_cart&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">shopping_cart)</span>
</pre></div>


<p>Let's now see all of our objects in action. We'll add items to the shopping cart
and then remove one.</p>
<h3 id="operation-1-add-four-items-to-the-shopping-cart">Operation 1:  Add four items to the shopping cart</h3>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">yosai</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai(env_var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;YOSAI_SETTINGS&#39;</span><span style="color: #f8f8f2">,</span>
                  <span style="color: #f8f8f2">session_attributes</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[ShoppingCart])</span>

    <span style="color: #f8f8f2">cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ShoppingCartSessionManager</span>

    <span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">context(yosai):</span>
      <span style="color: #f8f8f2">subject</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_current_subject()</span>
      <span style="color: #f8f8f2">session</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">subject</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_session()</span>

      <span style="color: #75715e"># could easily use functools.partial for this, but keeping it explicit</span>
      <span style="color: #75715e"># for the example so as to not confuse:</span>
      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add_item(session,</span> <span style="color: #e6db74">&#39;0043000200216&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">4</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add_item(session,</span> <span style="color: #e6db74">&#39;016000119772&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add_item(session,</span> <span style="color: #e6db74">&#39;52159012038&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add_item(session,</span> <span style="color: #e6db74">&#39;00028400028196&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>

      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">list_items(session)</span>
</pre></div>


<h3 id="operation-2-remove-an-item-from-the-shopping-cart">Operation 2:  Remove an item from the shopping cart</h3>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">yosai</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai(env_var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;YOSAI_SETTINGS&#39;</span><span style="color: #f8f8f2">,</span>
                  <span style="color: #f8f8f2">session_attributes</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[ShoppingCart])</span>

    <span style="color: #f8f8f2">cart</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ShoppingCartSessionManager(session)</span>

    <span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">context(yosai):</span>
      <span style="color: #f8f8f2">subject</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Yosai</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_current_subject()</span>
      <span style="color: #f8f8f2">session</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">subject</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_session()</span>

      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">remove_item(session,</span> <span style="color: #e6db74">&#39;00028400028196&#39;</span><span style="color: #f8f8f2">)</span>

      <span style="color: #f8f8f2">cart</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">list_items(session)</span>
</pre></div>


<h3 id="here-is-a-fully-working-example-of-the-code-shared-above"><a href="https://github.com/YosaiProject/yosai/blob/master/doc/docs/samplecode/sessionmanagement.py">Here</a> is a fully working example of the code shared above.</h3>
<h2 id="references">References</h2>
<p><a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet">OWASP Session Management CheatSheet</a></p></div>

        </div>

        <footer class="col-md-12">
            <hr>

            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>
        <script src="../js/extra.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
